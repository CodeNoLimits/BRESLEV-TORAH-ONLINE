# âœ… VERSION QUI MARCHE - Python
# pip install requests

import requests
import json
import time
from typing import Dict, Optional, List

class SefariaAPI:
    def __init__(self):
        self.base_url = "https://www.sefaria.org/api"
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (compatible; SefariaBot/1.0)',
            'Accept': 'application/json'
        })
    
    def fetch_text(self, reference: str) -> Optional[Dict]:
        """
        âœ… RÃ©cupÃ¨re un texte depuis Sefaria
        
        Args:
            reference: RÃ©fÃ©rence Sefaria (ex: 'Genesis.1.1', 'Talmud.Berakhot.2a')
            
        Returns:
            Dict avec les donnÃ©es du texte ou None si erreur
        """
        try:
            url = f"{self.base_url}/texts/{reference}"
            print(f"ğŸ“¡ Fetching: {url}")
            
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            
            data = response.json()
            
            if 'error' in data:
                raise Exception(f"API Error: {data['error']}")
            
            return data
            
        except requests.exceptions.RequestException as e:
            print(f"âŒ Erreur rÃ©seau: {e}")
            return None
        except Exception as e:
            print(f"âŒ Erreur: {e}")
            return None
    
    def search(self, query: str, size: int = 10) -> Optional[Dict]:
        """
        âœ… Recherche dans Sefaria
        
        Args:
            query: Terme Ã  rechercher
            size: Nombre de rÃ©sultats max
            
        Returns:
            Dict avec les rÃ©sultats de recherche
        """
        try:
            url = f"{self.base_url}/search-wrapper"
            params = {'q': query, 'size': size}
            
            response = self.session.get(url, params=params, timeout=10)
            response.raise_for_status()
            
            return response.json()
            
        except Exception as e:
            print(f"âŒ Erreur recherche: {e}")
            return None
    
    def get_index(self, title: str = None) -> Optional[Dict]:
        """
        âœ… RÃ©cupÃ¨re l'index des textes
        
        Args:
            title: Titre spÃ©cifique (optionnel)
            
        Returns:
            Dict avec l'index
        """
        try:
            if title:
                url = f"{self.base_url}/v2/index/{title}"
            else:
                url = f"{self.base_url}/index/"
            
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            
            return response.json()
            
        except Exception as e:
            print(f"âŒ Erreur index: {e}")
            return None

def display_text(data: Dict):
    """Affiche le texte de maniÃ¨re lisible"""
    print("\nğŸ“– RÃ‰SULTAT:")
    print("â”" * 50)
    print(f"ğŸ“š Livre: {data.get('book', 'N/A')}")
    print(f"ğŸ”– RÃ©fÃ©rence: {data.get('ref', 'N/A')}")
    
    # Texte hÃ©breu
    hebrew = data.get('he')
    if hebrew:
        if isinstance(hebrew, list):
            hebrew = ' '.join(str(h) for h in hebrew if h)
        print(f"\nğŸ”¤ HÃ©breu:\n{hebrew}")
    
    # Texte anglais
    english = data.get('text')
    if english:
        if isinstance(english, list):
            english = ' '.join(str(e) for e in english if e)
        print(f"\nğŸ‡ºğŸ‡¸ Anglais:\n{english}")
    
    print("â”" * 50 + "\n")

def main():
    """âœ… TESTS QUI MARCHENT"""
    sefaria = SefariaAPI()
    
    # Tests de rÃ©fÃ©rences diverses
    test_references = [
        'Genesis.1.1',
        'Psalms.23.1',
        'Talmud.Berakhot.2a',
        'Mishnah.Berakhot.1.1',
        'Sefer HaMidot.1.1'
    ]
    
    print("ğŸš€ DÃ©but des tests Sefaria API\n")
    
    for ref in test_references:
        print(f"ğŸ” Test: {ref}")
        data = sefaria.fetch_text(ref)
        
        if data:
            display_text(data)
        else:
            print(f"âŒ Ã‰chec pour {ref}\n")
        
        # DÃ©lai poli
        time.sleep(1)
    
    # Test de recherche
    print("ğŸ” Test de recherche:")
    results = sefaria.search("creation", size=3)
    if results and 'hits' in results:
        print(f"ğŸ“Š TrouvÃ© {len(results['hits'])} rÃ©sultats")
        for i, hit in enumerate(results['hits'][:3], 1):
            content = hit.get('content', '')[:100]
            print(f"{i}. {hit.get('ref', 'N/A')}: {content}...")
    
    print("\nâœ… Tests terminÃ©s!")

# âœ… USAGE SIMPLE
def quick_fetch(reference: str):
    """Fonction rapide pour rÃ©cupÃ©rer un texte"""
    sefaria = SefariaAPI()
    data = sefaria.fetch_text(reference)
    if data:
        display_text(data)
    return data

if __name__ == "__main__":
    main()
    
    # Exemples d'usage:
    # quick_fetch('Genesis.1.1')
    # quick_fetch('Psalms.23')
    # quick_fetch('Talmud.Berakhot.2a')